# å¤šçº¿ç¨‹å’Œå¼‚æ­¥





## å›é¡¾Javaä¸­çš„å¤šçº¿ç¨‹

### ç»§æ‰¿Threadç±»

- ç»§æ‰¿Threadç±»

  ```java
  package com.xuelingmiao.threadtest.threads;
  
  import android.util.Log;
  
  public class MyThread extends Thread {
      private static final String TAG = "MyThread";
  	//é‡å†™runæ–¹æ³•
      @Override
      public void run() {
          super.run();
          //éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡
          Log.d(TAG, "run: "+Thread.currentThread().getName());
      }
  }
  
  ```

  

- å¯åŠ¨çº¿ç¨‹

  ```java
   public void TestMyThread(){
       	//å®ä¾‹åŒ–ç»§æ‰¿äº†Threadçš„ç±»
          Thread t1 = new MyThread();
          Thread t2 = new MyThread();
          t1.start();	//å¯åŠ¨çº¿ç¨‹ã€‚
          t2.start();
      }
  ```

- æ‰§è¡Œç»“æœ

  ![image-20201218134109957](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218134109957.png)

  

### å®ç°Runnableæ¥å£

å¦‚æœå½“å‰ç±»ï¼Œå·²ç»ç»§æ‰¿å…¶å®ƒç±»ï¼Œä½†æ˜¯æˆ‘ä»¬åˆéœ€è¦å¤šçº¿ç¨‹å°±å¯ä»¥ä½¿ç”¨å®ç°Runnableæ–¹å¼æ¥å®ç°ã€‚

- å®ç°Runnableæ¥å£

  ```java
  package com.xuelingmiao.threadtest.threads;
  
  import android.util.Log;
  
  public class MyRunnable implements Runnable {
      private static final String TAG = "MyRunnable";
      //é‡å†™runæ–¹æ³•
      @Override
      public void run() {
          //è¦æ‰§è¡Œçš„ä»»åŠ¡
          Log.d(TAG, "run: "+Thread.currentThread().getName());
      }
  }
  
  ```

  

- å¯åŠ¨çº¿ç¨‹

  ```java
   public void TestRunnable(){
       	//å®ä¾‹å®ç°äº†Runnableæ¥å£çš„ç±»ã€‚
          MyRunnable runnable1 = new MyRunnable();
          MyRunnable runnable2 = new MyRunnable();
       	// å®ä¾‹Threadç±»ï¼Œå¹¶ä¼ é€’ä»»åŠ¡
          Thread t1 = new Thread(runnable1);
          Thread t2 = new Thread(runnable2);
       	//å¯åŠ¨çº¿ç¨‹
          t1.start();
          t2.start();
      }
  ```

  

- æ‰§è¡Œç»“æœ

  ![image-20201218135201196](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218135201196.png)

### çº¿ç¨‹åŒæ­¥

å¤šä¸ªThreadæ‰§è¡ŒåŒä¸€ä¸ªRunnableã€‚å¦‚ç”Ÿæ´»ä¸­è´­ä¹°ç«è½¦ç¥¨ï¼Œä¸åŒçš„äººå»æŠ¢è´­åŒä¸€åœ°åŸŸçš„ç«è½¦ç¥¨ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™é‡Œçš„äººçœ‹ä½œä¸ºThreadï¼ˆçº¿ç¨‹ï¼‰ç«è½¦ç¥¨çœ‹ä½œä¸ºRunnable.

åœ¨å¤šä¸ªçº¿ç¨‹,æ“ä½œåŒä¸€ä¸ªä»»åŠ¡æ—¶æˆ‘ä»¬éœ€è¦**é”ğŸ”’å¯¹è±¡**æ¥ä¿è¯çº¿ç¨‹ä¸å‡ºç°é—®é¢˜ã€‚



**æ¡ˆä¾‹ï¼›**

å¤šä¸ªçº¿ç¨‹å»å‡ºå”®åŒä¸€æ‰¹ç«è½¦ç¥¨ã€‚

- ç¼–å†™å”®ç¥¨ä»»åŠ¡ã€‚æŠŠéœ€è¦åŒæ­¥æ“ä½œçš„ä»£ç ä½¿ç”¨åŒæ­¥ä»£ç å—åŒ…è£¹ã€‚

  ```java
  package com.xuelingmiao.threadtest.threads.cases;
  
  import android.util.Log;
  
  public class SaleTicket implements Runnable {
      private static final String TAG = "SaleTicket";
      private int ticket = 20;	//æ€»ç¥¨æ•°
  
      @Override
      public void run() {
          while (true) {
              //ä½¿ç”¨åŒæ­¥ä»£ç å—ï¼Œè¿™é‡Œç´¢å¯¹è±¡ä½¿ç”¨this
              synchronized (this) {
                  //æœ‰ç¥¨
                  if (ticket > 0) {
                      Log.d(TAG, "run: " + Thread.currentThread().getName() + "å–å‡ºäº†ç¬¬" + (20 - ticket + 1) + "å¼ ");
                      ticket--; //æ¯å–å‡ºä¸€å¼ æ€»ç¥¨æ•°-1
                  }
                  //æ— ç¥¨ï¼Œç»“æŸå¾ªç¯ã€‚
                  else {
                      break;
                  }
              }
              // ä¼‘æ¯ä¸€ä¼šåœ¨ä¹°ç¥¨ã€‚
              try {
                  Thread.sleep(500);
              } catch (InterruptedException e) {
                  e.printStackTrace();
              }
          }
  
  
      }
  }
  
  ```

  

- äº¤ç»™ä¸åŒçº¿ç¨‹å»å”®å–ã€‚

  ```java
      public void testSaleTicket(){
          //å®ä¾‹åŒ–å”®ç¥¨ä»»åŠ¡ã€‚
          SaleTicket saleTicket = new SaleTicket();
          //åˆ†åˆ«äº¤ç»™ä¸åŒçº¿ç¨‹å»å”®å–ã€‚
          Thread t1 = new Thread(saleTicket,"{ä»£ç†A|");
          Thread t2 = new Thread(saleTicket,"{ä»£ç†B|");
          Thread t3 = new Thread(saleTicket,"{ä»£ç†C|");
          Thread t4 = new Thread(saleTicket,"{ä»£ç†D|");
          //å¯åŠ¨ä»»åŠ¡ã€‚
          t1.start();
          t2.start();
          t3.start();
          t4.start();
      }
  ```

  

- æ‰§è¡Œç»“æœ

  ![image-20201218144641511](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218144641511.png)



## çº¿ç¨‹æ± 



### ç¼“å­˜çº¿ç¨‹æ± ã€CachedThreadPoolã€‘

æ˜¯ä¸€ä¸ªæŒ‰éœ€åˆ›å»ºçš„çº¿ç¨‹æ± å¯¹è±¡ï¼Œæ ¹æ®å½“å‰ä»»åŠ¡æ•°è‡ªåŠ¨åˆ›å»ºå’Œé‡ç”¨çº¿ç¨‹ã€‚æ¯ä¸ªçº¿ç¨‹ç©ºé—²ç­‰å¾…çš„æ—¶é—´ä¸º60s

**åˆ›å»ºï¼›**

```java
 ExecutorService cachedThreadPool = Executors.newCachedThreadPool();
```

**ä½¿ç”¨ï¼›**

æ¨¡æ‹Ÿä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ã€‚ä¸ºäº†ä½“ç°ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡æ—¶æ˜¯ä½¿ç”¨çš„åŒä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™é‡Œæˆ‘ä»¬è®©çº¿ç¨‹ä¼‘æ¯ä¸€ä¸‹ï¼Œæ¥è¾¾åˆ°éå¹¶å‘æ·»åŠ çº¿ç¨‹ã€‚ä¸€ä¸ªä¸€ä¸ªæ·»åŠ ä»»åŠ¡åˆ°çº¿ç¨‹æ± ä¸­ã€‚

- `execute(Runnable runnable)`  æ‰§è¡Œä»»åŠ¡ã€‚
  - å‚æ•°ï¼›
    - `Runnable runnable` ä¸€ä¸ªRunnableæ¥å£ã€‚

```java
public void testCache(){
        ExecutorService cachedThreadPool = Executors.newCachedThreadPool();
        for (int i = 0; i < 10; i++) {
            final int index = i;
            //æ¨¡æ‹Ÿä¸€ä¸ªç©ºé—²æ—¶é—´
            try {
                Thread.sleep(2000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            //æ·»åŠ ä»»åŠ¡åˆ°çº¿ç¨‹æ± ã€‚
            cachedThreadPool.execute(new Runnable() {
                @Override
                public void run() {
                    Log.d(TAG, "run: æ‰§è¡Œä»»åŠ¡"+Thread.currentThread().getName()+"ç¬¬"+index+"ä»»åŠ¡");
                }
            });
        }
    }
```

æ‰§è¡Œç»“æœï¼›å¯ä»¥çœ‹åˆ°å½“å‰çš„ä»»åŠ¡éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆçš„ã€‚ï¼ˆpool-1-thread-1ï¼‰

![image-20201218202346646](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218202346646.png)



### å›ºå®šçº¿ç¨‹æ± ã€FixedThreadPoolã€‘

ä¸€ä¸ªå¯ä»¥æ§åˆ¶å¹¶å‘ï¼ˆåŒæ—¶æ‰§è¡Œï¼‰çš„çº¿ç¨‹æ± ã€‚åŒæ—¶å›ºå®šçº¿ç¨‹æ± é•¿åº¦ã€‚

**åˆ›å»ºï¼›**

Executorsç±»ä¸­çš„åˆ›å»ºæ–¹æ³•ï¼š

- `Executors.newFixedThreadPool(int corePoolSize)`åˆ›å»ºå¯é‡ç”¨å›ºå®šçº¿ç¨‹æ•°
  - å‚æ•°
    - `int corePoolSize` æ ¸å¿ƒçº¿ç¨‹æ•°åŠåŒæ—¶æ‰§è¡Œçº¿ç¨‹ä¸ªæ•°ã€‚
  - è¿”å›å€¼
    - ExecutorService

```java
ExecutorService fixedThreadPool = Executors.newFixedThreadPool(3);
```



**ä½¿ç”¨ï¼›**

```java
 public void testFixedThreadPool() {
        ExecutorService fixedThreadPool = Executors.newFixedThreadPool(3);
        for (int i = 0; i < 10; i++) {
            final int index = i;
            fixedThreadPool.execute(new Runnable() {
                @Override
                public void run() {
                    Log.d(TAG, "run: " + Thread.currentThread().getName() + "å½“å‰æ‰§è¡Œçš„ä»»åŠ¡æ˜¯" + index);
                    //åŒæ—¶è®©æ¯ä¸€ä¸ªæ‰§è¡Œåˆ°è¿™é‡Œçš„çº¿ç¨‹ä¼‘çœ ä¸€ä¸‹ã€‚
                    try {
                        Thread.sleep(2000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            });
        }
```



æ‰§è¡Œç»“æœï¼›å¯ä»¥çœ‹åˆ°è¿™é‡Œçš„æœ€é«˜å¹¶å‘æ•°é‡åªæœ‰åˆ°3.è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šå‡ºç°ä¸€æ¬¡æœ‰ä¸‰ä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œçš„æ•ˆæœï¼Œä¹‹åè¿™ä¸‰ä¸ªä»»åŠ¡ä¼šåŒæ—¶ä¼‘çœ ä¸€ä¼šã€‚

![image-20201218204130503](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218204130503.png)



### å•çº¿ç¨‹ã€SingleThreadExecutorã€‘

åªä¼šç”¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œä¿è¯æ‰€æœ‰çš„ä»»åŠ¡æŒ‰æŒ‡å®šçš„ä¼˜å…ˆçº§é¡ºåºæ¥æ‰§è¡Œã€‚

**åˆ›å»ºï¼›**

```java
 ExecutorService singleThreadExecutor = Executors.newSingleThreadExecutor();
```

**ä½¿ç”¨ï¼›**

```java
 public void testSingleThreadExecutor(){
        ExecutorService singleThreadExecutor = Executors.newSingleThreadExecutor();
        for (int i = 0; i < 10; i++) {
            final int index = i;
            singleThreadExecutor.execute(new Runnable() {
                @Override
                public void run() {
                    Log.d(TAG, "run: "+Thread.currentThread().getName()+"æ‰§è¡Œä»»åŠ¡"+index);
                    try {
                        Thread.sleep(1000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                }
            });
        }
    }
```

æ‰§è¡Œç»“æœï¼› å¯ä»¥çœ‹åˆ°å§‹ç»ˆåªæœ‰ä¸€ä¸ªThreadï¼ˆpool-1-thread-1ï¼‰åœ¨æ‰§è¡Œã€‚ä»»åŠ¡

![image-20201218210258617](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218210258617.png)



### å®šæ—¶å»¶æ—¶æ‰§è¡Œã€ScheduledThreadPoolã€‘

æ”¯æŒæŒ‡å®šé•¿åº¦çš„ï¼Œçº¿ç¨‹æ± åŒæ—¶æ”¯æŒå®šæ—¶æ‰§è¡Œä»»åŠ¡å’Œå‘¨æœŸï¼ˆæŒ‰æŒ‡å®šçš„æ—¶é—´é—´è·æ‰§è¡Œä»»åŠ¡ï¼‰æ‰§è¡Œä»»åŠ¡ã€‚

**åˆ›å»ºï¼›**

```java
ScheduledExecutorService singleThreadScheduledExecutor = Executors.newSingleThreadScheduledExecutor();
```



**ä½¿ç”¨ï¼›**

å»¶è¿Ÿæ‰§è¡Œæƒ¹ä»»åŠ¡ã€‚

- `schedule(Runnable var1, long var2, TimeUnit var4)` å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ã€‚
  - å‚æ•°ï¼›
    - `Runnable var1` è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚
    - `long var2 ` å»¶è¿Ÿæ—¶é—´ã€‚
    -  `TimeUnit var4 ` å»¶è¿Ÿçš„æ—¶é—´å•ä½ã€‚
- `scheduleAtFixedRate(Runnable var1, long var2, long var4, TimeUnit var6)` å»¶è¿Ÿå‘¨æœŸä»»åŠ¡ã€‚
  - å‚æ•°ï¼›
    - Runnable var1 è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚
    - long var2  å»¶è¿Ÿé¦–æ¬¡æ‰§è¡Œçš„æ—¶é—´ã€‚
    - long var4  è¿ç»­æ‰§è¡Œçš„å‘¨æœŸæ—¶é—´ã€‚
    - TimeUnit var6  å»¶è¿Ÿå’Œå‘¨æœŸçš„æ—¶é—´å•ä½ã€‚
- `shutdown()` ç»“æŸå‘¨æœŸå®šæ—¶ã€‚

 ```java
 public void testSingleThreadScheduledExecutor(){
        Log.d(TAG, "test: ä¸‰ç§’åå°†æ‰§è¡Œä»»åŠ¡");
        ScheduledExecutorService singleThreadScheduledExecutor = Executors.newSingleThreadScheduledExecutor();
     //å»¶è¿Ÿæ‰§è¡Œä»»åŠ¡ã€‚
        singleThreadScheduledExecutor.schedule(new Runnable() {
            @Override
            public void run() {
                Log.d(TAG, "run: "+Thread.currentThread().getName()+"æ¨¡æ‹Ÿä»»åŠ¡");
            }
        },3, TimeUnit.SECONDS);
     
     //å‘¨æœŸæ‰§è¡Œä»»åŠ¡ã€‚
     singleThreadScheduledExecutor.scheduleAtFixedRate(new Runnable() {
            @Override
            public void run() {
                Log.d(TAG, "run: æ¨¡æ‹Ÿä»»åŠ¡"+Thread.currentThread().getName());
            }
        },2,3,TimeUnit.SECONDS);
     
     
     
    }
 ```

æ‰§è¡Œç»“æœï¼›

![image-20201218212849967](%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1-images/image-20201218212849967.png)





## çº¿ç¨‹æ± éƒ¨åˆ†æ–¹æ³•

- `shutDown()` å…³é—­çº¿ç¨‹æ± ï¼Œä¸å½±å“å·²ç»æäº¤çš„ä»»åŠ¡
- `shutDownNow()` å…³é—­çº¿ç¨‹æ± ï¼Œå¹¶å°è¯•å»ç»ˆæ­¢æ­£åœ¨æ‰§è¡Œçš„çº¿ç¨‹
- `allowCoreThreadTimeOut(boolean value) å…è®¸`æ ¸å¿ƒçº¿ç¨‹é—²ç½®è¶…æ—¶æ—¶è¢«å›æ”¶
- `submit()` ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨executeæ¥æäº¤ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰æ—¶å€™å¯èƒ½ä¹Ÿä¼šç”¨åˆ°submitï¼Œä½¿ç”¨submitçš„å¥½å¤„æ˜¯submitæœ‰è¿”å›å€¼ã€‚
- `execute(runnable)` æ‰§è¡Œä»»åŠ¡
- `beforeExecute()` - ä»»åŠ¡æ‰§è¡Œå‰æ‰§è¡Œçš„æ–¹æ³•
- `afterExecute()` -ä»»åŠ¡æ‰§è¡Œç»“æŸåæ‰§è¡Œçš„æ–¹æ³•
- `terminated()` -çº¿ç¨‹æ± å…³é—­åæ‰§è¡Œçš„æ–¹æ³•





